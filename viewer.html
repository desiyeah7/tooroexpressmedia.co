<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viewer - Tooro Express Media</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:#111; color:#fff; text-align:center; }
#logo { width:120px; margin:20px auto; display:block; }
#programTitleWrapper { width:90%; max-width:800px; background:#1976d2; border-radius:10px; padding:10px; margin:10px auto; overflow:hidden; position:relative; }
#programTitle { display:inline-block; padding-left:100%; white-space:nowrap; font-size:20px; font-weight:bold; color:#fff; animation:scrollTitle 15s linear infinite; }
@keyframes scrollTitle { from { transform:translateX(0); } to { transform:translateX(-100%); } }
#liveIndicator { width:15px; height:15px; background:gray; border-radius:50%; display:inline-block; margin-left:10px; vertical-align:middle; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{ transform:scale(1);}50%{transform:scale(1.3);} }
#viewerVideo { width:90%; max-width:900px; margin:20px auto; border-radius:12px; border:2px solid #4caf50; background:black; }
#chatBox { width:90%; max-width:500px; margin:20px auto; text-align:left; }
#messages { height:200px; overflow-y:auto; border:1px solid #555; padding:10px; margin-bottom:10px; border-radius:8px; background:#222; }
input, button { padding:8px; margin:5px; border-radius:5px; border:none; }
button { cursor:pointer; background:#4caf50; color:#fff; font-weight:bold; }
</style>
</head>
<body>

<img src="mark.jpg" id="logo" alt="Tooro Express Media Logo">

<div id="programTitleWrapper">
  <span id="programTitle">Welcome to Tooro Express Media Live!</span>
  <span id="liveIndicator" title="Live"></span>
</div>

<video id="viewerVideo" autoplay playsinline></video> 

<div id="chatBox">
  <div id="messages"></div>
  <input type="text" id="chatInput" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>
</div>

<div>
  <button id="likeBtn">Like üëç</button> <span id="likes">0</span>
  <button id="subscribeBtn">Subscribe üîî</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// --- CONFIG & INITIALIZATION ---
const firebaseConfig = {
  apiKey: "AIzaSyDyIloGwy7UzZUAqodgZNvNCiBou02RbGQ",
  authDomain: "livestream-trial.firebaseapp.com",
  databaseURL: "https://livestream-trial-default-rtdb.firebaseio.com",
  projectId: "livestream-trial",
  storageBucket: "livestream-trial.appspot.com",
  messagingSenderId: "448193920796",
  appId: "1:448193920796:web:019cf2b7295e0e7d7c04d9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// --- DOM ELEMENTS & RTC VARIABLES ---
const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
const viewerVideo = document.getElementById("viewerVideo");
const programTitle = document.getElementById("programTitle");
const liveIndicator = document.getElementById("liveIndicator");
const messagesDiv = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const likesSpan = document.getElementById("likes");
const likeBtn = document.getElementById("likeBtn");
const subscribeBtn = document.getElementById("subscribeBtn");
const pc = new RTCPeerConnection(rtcConfig);

// --- VIEWER ID & SETUP ---
// Generates a unique viewer ID and registers it
const viewerRef = db.ref("viewers").push(); 
const viewerId = viewerRef.key;
viewerRef.set(true);
viewerRef.onDisconnect().remove();

// --- LIVE STATUS CHECK ---
db.ref("isLive").on("value", snap => {
    const isLive = snap.val();
    liveIndicator.style.background = isLive ? "red" : "gray";
    liveIndicator.title = isLive ? "Live" : "Offline";
});

// --- PROGRAM TITLE & BACKGROUND ---
db.ref("programTitle").on("value", snap=> programTitle.textContent = snap.val() || "Welcome to Tooro Express Media Live!");

// You may want to add logic here to display the background image/video
// based on db.ref("background") similar to how the owner side handles it.

// --- WebRTC (SIGNALING) ---

// 1. Listen for OFFER from the owner
db.ref(`webrtc/${viewerId}/offer`).on("value", async snap=>{
  const offer = snap.val();
  if(!offer) return;

  // A. Set remote description (Offer)
  await pc.setRemoteDescription(JSON.parse(offer));

  // B. Create Answer and set local description
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  // C. Send Answer back to the owner
  db.ref(`webrtc/${viewerId}/answer`).set(JSON.stringify(answer));
});

// 2. Send Viewer's ICE Candidates to the Owner
pc.onicecandidate = e=>{
  // Viewer candidates go to /webrtc/{viewerId}/candidatesViewer
  if(e.candidate) db.ref(`webrtc/${viewerId}/candidatesViewer`).push(JSON.stringify(e.candidate));
};

// 3. Receive Stream Tracks from the Owner
pc.ontrack = e => {
    viewerVideo.srcObject = e.streams[0];
    // Attempt to play immediately (requires no 'muted' attribute in HTML)
    viewerVideo.play().catch(error => {
        console.warn("Autoplay was blocked. Viewer may need to interact with the page.", error);
    });
};

// 4. Listen for Owner's ICE Candidates
db.ref(`webrtc/${viewerId}/candidates`).on("child_added", snap=>{
  try {
    pc.addIceCandidate(JSON.parse(snap.val()));
  } catch(e) {
    console.error("Error adding owner candidate:", e);
  }
});


// --- CHAT FUNCTIONS ---
function sendMessage(){
  // Added a placeholder name for the viewer, as you didn't include auth
  const viewerName = `Viewer-${viewerId.substring(0, 4)}`;
  const msg = chatInput.value.trim();
  if(!msg) return;
  
  db.ref("chat").push({
    id: viewerId,
    name: viewerName,
    text: msg,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
  chatInput.value = "";
}

db.ref("chat").on("child_added", snap=>{
  const msg = snap.val();
  const div = document.createElement("div");
  // Updated to show a name/ID if available
  const senderInfo = msg.name ? `[${msg.name}]: ` : '';
  div.textContent = senderInfo + msg.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// --- LIKES ---
let liked = false;
likeBtn.onclick = ()=>{
  // Prevents spamming the like button
  if(liked) return; 
  liked = true;
  db.ref("likes").transaction(current=> (current||0)+1 );
};
db.ref("likes").on("value", snap=> likesSpan.textContent = snap.val() || 0);

// --- SUBSCRIBE ---
subscribeBtn.onclick = ()=> alert("Thank you for subscribing!");
</script>
</body>
</html>

